# GAA Events API Endpoint

## ğŸ¯ Purpose

API endpoint for Lambda functions to store events from AI analysis pipeline into the database.

---

## ğŸ“ Endpoint

**POST** `/api/games/:id/events`

**Authentication:** Lambda API key (X-API-Key header)

---

## ğŸ” Authentication

Lambda must send API key in header:
```
X-API-Key: gaa-lambda-secret-key-change-in-production
```

**Environment Variable:** `LAMBDA_API_KEY` in backend `.env`

---

## ğŸ“¥ Request Format

**URL:** `POST /api/games/{game_id}/events`

**Headers:**
```
Content-Type: application/json
X-API-Key: {lambda-api-key}
```

**Body:**
```json
{
  "events": [
    {
      "id": "event_1",
      "time": 19,
      "team": "blue",
      "action": "Kickout",
      "outcome": "Lost",
      "autoGenerated": true,
      "validated": false
    },
    {
      "id": "event_2",
      "time": 54,
      "team": "red",
      "action": "Shot",
      "outcome": "1Point",
      "autoGenerated": true,
      "validated": false
    }
  ],
  "match_info": {
    "title": "GAA Match - Events",
    "total_events": 32,
    "analysis_method": "AI narrative analysis"
  },
  "team_mapping": {
    "red": "home",
    "blue": "away"
  }
}
```

**Required Fields:**
- `events` (array) - Array of event objects

**Optional Fields:**
- `match_info` (object) - Match metadata
- `team_mapping` (object) - Maps team colors to home/away

---

## ğŸ“¤ Response Format

**Success (200):**
```json
{
  "message": "Events stored successfully",
  "game_id": "uuid",
  "events_count": 32,
  "status": "analyzed"
}
```

**Error (400):**
```json
{
  "error": "Events must be an array"
}
```

**Error (401):**
```json
{
  "error": "Invalid API key"
}
```

**Error (404):**
```json
{
  "error": "Game not found"
}
```

---

## ğŸ”„ What Happens

1. **Validates API key** - Checks X-API-Key header
2. **Validates game exists** - Checks game ID in database
3. **Validates events** - Ensures events is an array
4. **Stores events** - Updates `events` JSONB field in database
5. **Updates status** - Sets `status = 'analyzed'`
6. **Returns success** - Confirms events stored

---

## ğŸ’¾ Database Storage

Events are stored in `games.events` JSONB field:

```json
{
  "match_info": {
    "title": "GAA Match - Events",
    "total_events": 32,
    "analysis_method": "AI narrative analysis",
    "created_at": "2025-01-13T..."
  },
  "events": [
    {
      "id": "event_1",
      "time": 19,
      "team": "blue",
      "action": "Kickout",
      "outcome": "Lost",
      "autoGenerated": true,
      "validated": false
    }
  ],
  "team_mapping": {
    "red": "home",
    "blue": "away"
  },
  "updated_at": "2025-01-13T..."
}
```

---

## ğŸ”§ Lambda Usage

### Option 1: Call API Endpoint (Recommended)

```python
import requests

def store_events_via_api(game_id, events_data):
    api_url = f"{BACKEND_API_URL}/api/games/{game_id}/events"
    
    response = requests.post(
        api_url,
        json=events_data,
        headers={
            'Content-Type': 'application/json',
            'X-API-Key': LAMBDA_API_KEY
        }
    )
    
    response.raise_for_status()
    return response.json()
```

**Lambda Environment Variables:**
- `BACKEND_API_URL` - Backend API URL (e.g., `https://gaa-backend.vercel.app`)
- `LAMBDA_API_KEY` - API key matching backend `LAMBDA_API_KEY`

### Option 2: Direct Database Write (Current)

Lambda can still write directly to database (like it does for `s3_key`):

```python
def update_database_events(game_id, events_data):
    conn = psycopg2.connect(DATABASE_URL, sslmode='require')
    cur = conn.cursor()
    
    cur.execute(
        "UPDATE games SET events = %s::jsonb, status = 'analyzed' WHERE id = %s",
        (json.dumps(events_data), game_id)
    )
    conn.commit()
    cur.close()
    conn.close()
```

---

## ğŸ§ª Testing

### Test with curl:

```bash
curl -X POST http://localhost:4011/api/games/{game-id}/events \
  -H "Content-Type: application/json" \
  -H "X-API-Key: gaa-lambda-secret-key-change-in-production" \
  -d '{
    "events": [
      {
        "id": "test_1",
        "time": 10,
        "team": "red",
        "action": "Shot",
        "outcome": "1Point",
        "autoGenerated": true,
        "validated": false
      }
    ]
  }'
```

### Test from Lambda:

```python
# In Lambda handler
events_data = {
    "events": [...],
    "match_info": {...},
    "team_mapping": {...}
}

store_events_via_api(game_id, events_data)
```

---

## ğŸ”’ Security

- **API Key Required** - Lambda must send correct `X-API-Key` header
- **No User Auth** - This endpoint is Lambda-only (no JWT needed)
- **Game Validation** - Verifies game exists before storing
- **Data Validation** - Validates events structure

**Set API Key:**
```bash
# Backend .env
LAMBDA_API_KEY=your-secret-api-key-here

# Lambda Environment Variables
LAMBDA_API_KEY=your-secret-api-key-here
BACKEND_API_URL=https://gaa-backend.vercel.app
```

---

## âœ… Status

- âœ… Endpoint created: `POST /api/games/:id/events`
- âœ… Lambda authentication middleware added
- âœ… Events validation implemented
- âœ… Database storage working
- â³ Lambda helper function added (can use API or direct DB)

---

**Last Updated:** 2025-01-13  
**GAA Webapp - Events API**

