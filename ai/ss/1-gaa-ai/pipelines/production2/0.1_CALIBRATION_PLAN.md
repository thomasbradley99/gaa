# Calibration Pipeline - Pre-Processing Steps

## Overview
Add two new scripts before Stage 1 to set up game context and improve AI accuracy.

---

## 0_generate_clips_and_frames.py ✅
**Purpose:** Split raw video into clips and extract calibration frames

**Input:**
- `games/{game}/inputs/video.mp4` (raw video)

**Process:**
1. Use ffmpeg to split video into 1-minute clips
2. Save to `games/{game}/inputs/clips/clip_000m00s.mp4`, etc.
3. Extract 1 frame every 30 seconds → `games/{game}/inputs/calibration_frames/`

**Output:**
- `games/{game}/inputs/clips/` (60-second MP4 clips)
- `games/{game}/inputs/calibration_frames/` (frames for calibration)

**Cost:** Free (ffmpeg)

---

## 0.3_calibrate_game.py ✅
**Purpose:** Profile the game to provide context for clip analysis

**Input:**
- `games/{game}/inputs/calibration_frames/` (extracted frames)

**Process:**
1. Send frames to Gemini 2.5 Flash
2. AI identifies:
   - Team A colors (jersey + goalkeeper)
   - Team B colors (jersey + goalkeeper)
   - 1st half start/end times
   - 2nd half start/end times  
   - Attacking directions per half (which team attacks which way)

**Output:**
- `games/{game}/inputs/game_profile.json`

```json
{
  "team_home": {
    "jersey_color": "Light blue",
    "keeper_color": "Pink",
    "attack_direction_1st_half": "left-to-right",
    "attack_direction_2nd_half": "right-to-left"
  },
  "team_away": {
    "jersey_color": "Dark blue", 
    "keeper_color": "Green",
    "attack_direction_1st_half": "right-to-left",
    "attack_direction_2nd_half": "left-to-right"
  },
  "half_times": {
    "1st_half_start": 705,
    "1st_half_end": 3037,
    "2nd_half_start": 3148,
    "2nd_half_end": 6091
  }
}
```

**Cost:** ~$0.05 (one Flash call, ~120 frames)

---

## Modified: 1_clips_to_descriptions.py
**Changes:**
1. Load `game_profile.json` at startup
2. For each clip, inject context into prompt:
   - Current clip time range
   - Which half it's in
   - Team colors (no need to re-identify)
   - Attacking directions for this half

**Benefits:**
- AI knows exactly where it is in the match
- No re-identifying teams every clip
- Correct attacking direction per half
- Fewer hallucinations
- More consistent event detection

---

## Workflow

```bash
# One-time setup per game:
python 0.2_generate_clips_and_frames.py --game ecnl-2012-vs-op
python 0.3_calibrate_game.py --game ecnl-2012-vs-op

# Then run normal pipeline:
python 1_clips_to_descriptions.py --game ecnl-2012-vs-op --start-clip 11 --end-clip 20
python 2_create_coherent_narrative.py --game ecnl-2012-vs-op
# ... etc
```

