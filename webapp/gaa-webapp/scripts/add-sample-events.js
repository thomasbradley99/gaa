#!/usr/bin/env node
/**
 * Add Sample Events to Game
 * 
 * Adds sample GAA events from AI pipeline to a game for testing display.
 * 
 * Usage:
 *   node scripts/add-sample-events.js <game-id>
 *   OR
 *   node scripts/add-sample-events.js --video-url "https://c.veocdn.com/..."
 * 
 * Make sure DATABASE_URL is set in environment or backend/.env
 */

// Load environment variables
const path = require('path');
const fs = require('fs');
const envPath = path.join(__dirname, '../backend/.env');
if (fs.existsSync(envPath)) {
  const envContent = fs.readFileSync(envPath, 'utf8');
  envContent.split('\n').forEach(line => {
    const [key, ...valueParts] = line.split('=');
    if (key && valueParts.length > 0) {
      const value = valueParts.join('=').trim();
      if (!process.env[key.trim()]) {
        process.env[key.trim()] = value.replace(/^["']|["']$/g, '');
      }
    }
  });
}

const { query } = require('../backend/utils/database');

// Sample events from AI pipeline (GAA Events Schema format)
const sampleEvents = {
  match_info: {
    title: "GAA Match - Sample Events",
    description: "Sample events for testing display",
    total_events: 32,
    analysis_method: "AI narrative analysis"
  },
  events: [
    {
      id: "event_1",
      time: 19,
      team: "blue",
      action: "Kickout",
      outcome: "Lost",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_2",
      time: 54,
      team: "red",
      action: "Kickout",
      outcome: "Lost",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_3",
      time: 60,
      team: "blue",
      action: "Turnover",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_4",
      time: 75,
      team: "red",
      action: "Foul",
      outcome: "N/A",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_5",
      time: 90,
      team: "red",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_6",
      time: 135,
      team: "red",
      action: "Foul",
      outcome: "N/A",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_7",
      time: 180,
      team: "red",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_8",
      time: 194,
      team: "blue",
      action: "Kickout",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_9",
      time: 195,
      team: "blue",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_10",
      time: 210,
      team: "blue",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_11",
      time: 217,
      team: "red",
      action: "Kickout",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_12",
      time: 246,
      team: "red",
      action: "Kickout",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_13",
      time: 255,
      team: "red",
      action: "Shot",
      outcome: "Wide",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_14",
      time: 269,
      team: "blue",
      action: "Kickout",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_15",
      time: 285,
      team: "blue",
      action: "Shot",
      outcome: "Wide",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_16",
      time: 297,
      team: "red",
      action: "Kickout",
      outcome: "Lost",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_17",
      time: 315,
      team: "blue",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_18",
      time: 339,
      team: "red",
      action: "Kickout",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_19",
      time: 365,
      team: "blue",
      action: "Kickout",
      outcome: "Lost",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_20",
      time: 375,
      team: "red",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_21",
      time: 405,
      team: "red",
      action: "Kickout",
      outcome: "Lost",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_22",
      time: 420,
      team: "blue",
      action: "Shot",
      outcome: "Wide",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_23",
      time: 432,
      team: "red",
      action: "Kickout",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_24",
      time: 435,
      team: "red",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_25",
      time: 465,
      team: "red",
      action: "Foul",
      outcome: "N/A",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_26",
      time: 480,
      team: "blue",
      action: "Foul",
      outcome: "N/A",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_27",
      time: 510,
      team: "blue",
      action: "Kickout",
      outcome: "Lost",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_28",
      time: 511,
      team: "red",
      action: "Shot",
      outcome: "Goal",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_29",
      time: 526,
      team: "red",
      action: "Kickout",
      outcome: "Lost",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_30",
      time: 555,
      team: "red",
      action: "Shot",
      outcome: "1Point",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_31",
      time: 564,
      team: "blue",
      action: "Kickout",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    },
    {
      id: "event_32",
      time: 585,
      team: "blue",
      action: "Turnover",
      outcome: "Won",
      autoGenerated: true,
      validated: false
    }
  ],
  team_mapping: {
    red: "home",
    blue: "away"
  }
};

async function addEventsToGame(gameId) {
  try {
    console.log(`üìù Adding sample events to game: ${gameId}`);
    
    // Check if game exists
    const gameResult = await query('SELECT id, title FROM games WHERE id = $1', [gameId]);
    if (gameResult.rows.length === 0) {
      console.error(`‚ùå Game not found: ${gameId}`);
      process.exit(1);
    }
    
    const game = gameResult.rows[0];
    console.log(`‚úÖ Found game: ${game.title}`);
    
    // Update database with events
    const updateResult = await query(
      `UPDATE games 
       SET events = $1::jsonb, 
           status = 'analyzed',
           updated_at = NOW()
       WHERE id = $2
       RETURNING id, title, status`,
      [JSON.stringify(sampleEvents), gameId]
    );
    
    console.log(`‚úÖ Events added successfully!`);
    console.log(`   Game: ${updateResult.rows[0].title}`);
    console.log(`   Status: ${updateResult.rows[0].status}`);
    console.log(`   Events count: ${sampleEvents.events.length}`);
    
  } catch (error) {
    console.error('‚ùå Error adding events:', error);
    process.exit(1);
  }
}

async function findGameByVideoUrl(videoUrl) {
  try {
    console.log(`üîç Searching for game with video URL containing: ${videoUrl.substring(0, 50)}...`);
    
    const result = await query(
      `SELECT id, title, video_url FROM games WHERE video_url LIKE $1 LIMIT 1`,
      [`%${videoUrl}%`]
    );
    
    if (result.rows.length === 0) {
      console.error(`‚ùå No game found with that video URL`);
      return null;
    }
    
    return result.rows[0];
  } catch (error) {
    console.error('‚ùå Error searching for game:', error);
    return null;
  }
}

// Main
async function main() {
  const args = process.argv.slice(2);
  
  if (args.length === 0) {
    console.log('Usage:');
    console.log('  node scripts/add-sample-events.js <game-id>');
    console.log('  node scripts/add-sample-events.js --video-url "https://c.veocdn.com/..."');
    process.exit(1);
  }
  
  let gameId = null;
  
  if (args[0] === '--video-url' && args[1]) {
    const videoUrl = args[1];
    const game = await findGameByVideoUrl(videoUrl);
    if (!game) {
      process.exit(1);
    }
    gameId = game.id;
    console.log(`‚úÖ Found game: ${game.title} (${game.id})`);
  } else {
    gameId = args[0];
  }
  
  await addEventsToGame(gameId);
  process.exit(0);
}

main();

