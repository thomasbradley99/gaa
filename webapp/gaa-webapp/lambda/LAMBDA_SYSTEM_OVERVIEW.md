# GAA Lambda System - Complete Overview

## ğŸ¯ Two-Lambda Architecture

### **Lambda 1: VEO Downloader** âœ… DEPLOYED
**Function:** `gaa-veo-downloader-nov25`  
**Status:** Active (deployed Nov 16, 2025)

**Job:**
- Downloads video from VEO URL
- Extracts thumbnail (5s timestamp)
- Uploads to S3: `videos/{game_id}/video.mp4`
- Updates DB: `status='downloaded'`
- **Triggers Lambda 2** automatically

**Duration:** ~70 seconds  
**Memory:** 3GB

---

### **Lambda 2: AI Analyzer** ğŸ†• READY TO DEPLOY
**Function:** `gaa-ai-analyzer-nov25`  
**Status:** Code ready, not yet deployed

**Job:**
- Downloads video from S3
- **Stage 0.5: Calibrates game** â†’ Finds match start time
- Extracts first 10 minutes **from match start**
- Runs AI analysis (Gemini)
- Detects GAA events (shots, fouls, kickouts, etc.)
- Posts events to backend API
- Updates DB: `status='analyzed'`

**Duration:** ~3-4 minutes  
**Memory:** 10GB

---

## ğŸ”„ Complete Flow

```
1. User submits VEO URL via webapp
   â†“
2. Backend creates game record (status='pending')
   â†“
3. Backend triggers Lambda 1 (gaa-veo-downloader-nov25)
   â†“
4. Lambda 1: Downloads video (~70s)
   â”œâ”€â”€ Extracts thumbnail
   â”œâ”€â”€ Uploads to S3: videos/{game_id}/video.mp4
   â””â”€â”€ Updates DB: status='downloaded'
   â†“
5. Lambda 1 triggers Lambda 2 (gaa-ai-analyzer-nov25)
   â†“
6. Lambda 2: AI Analysis (~3-4 min)
   â”œâ”€â”€ Stage 0.0: Extract calibration frames
   â”œâ”€â”€ Stage 0.5: Calibrate game (detect teams & START TIME)
   â”œâ”€â”€ Stage 0.1: Extract first 10 mins FROM MATCH START
   â”œâ”€â”€ Stage 0.2: Generate 10 clips (60s each)
   â”œâ”€â”€ Stage 1: Parallel AI analysis (Gemini - 10 clips at once)
   â”œâ”€â”€ Stages 2-4: Narrative â†’ Event classification â†’ JSON
   â””â”€â”€ Stage 5: Export to Anadi XML
   â†“
7. Lambda 2 posts events to backend API
   â†“
8. Backend stores events in DB (status='analyzed')
   â†“
9. Frontend polls DB, sees events, displays on timeline âœ¨
```

---

## ğŸ¬ Why Start Time Detection Matters

### Problem: VEO videos include pre-match footage

```
0:00 - 2:00   Empty field, camera setup
2:00 - 5:00   Teams warming up
5:00 - 7:00   Team introductions
7:00 - 7:30   Captains meet referee
7:30          ğŸˆ ACTUAL MATCH STARTS (throw-up)
```

### Solution: Stage 0.5 Calibration

Lambda 2 extracts 3 frames (30s, 5min, 25min) and uses AI to detect:
- **Team colors** (Blue vs White)
- **Keeper colors** (Pink vs Green)
- **Match start time** (e.g., 300s = 5 minutes into recording)
- **Attacking directions** (left-to-right vs right-to-left)

**Result:** Analysis starts from actual match time, not recording start!

---

## ğŸ“Š Event Data Format

### Lambda 2 Output (Posted to Backend):

```json
{
  "events": [
    {
      "id": "event_1",
      "time": 23,          // 23 seconds INTO THE MATCH
      "team": "home",
      "action": "Throw-up",
      "outcome": "Won",
      "metadata": {
        "autoGenerated": true,
        "validated": false
      }
    },
    {
      "id": "event_2",
      "time": 65,
      "team": "home",
      "action": "Shot",
      "outcome": "Point",
      "metadata": {
        "scoreType": "point",
        "from": "play",
        "autoGenerated": true
      }
    }
  ],
  "match_info": {
    "title": "10-minute analysis",
    "total_events": 50,
    "analysis_method": "Gemini AI",
    "recording_start_time": 300  // Match started at 5:00 in recording
  },
  "team_mapping": {
    "red": "home",
    "blue": "away"
  }
}
```

### Frontend Display:

```typescript
// event-transformer.ts transforms AI format â†’ Display format
{
  id: "event_2",
  type: "shot",           // mapped from "action"
  timestamp: 65,          // time from match start
  team: "home",
  description: "Home scores a point",
  metadata: { scoreType: "point", from: "play" }
}
```

**Video timeline shows events at match-relative times** (0:00, 0:23, 1:05, etc.)

---

## ğŸš€ Deployment Status

### Lambda 1 (VEO Downloader)
âœ… **DEPLOYED** - Nov 16, 2025
- Function exists in AWS
- Triggering works from backend
- Successfully downloads videos
- Thumbnails generated
- Ready to trigger Lambda 2

### Lambda 2 (AI Analyzer)
ğŸ†• **READY TO DEPLOY** - Nov 17, 2025

**Files created:**
- `lambda_handler_s3.py` - Main handler (S3 version)
- `deploy-s3.sh` - Deployment script
- `README_S3.md` - Documentation

**To deploy:**
```bash
cd /home/ubuntu/clann/gaa/webapp/gaa-webapp/lambda/gaa-ai-analyzer

# Set required environment variables
export GEMINI_API_KEY="your-gemini-api-key"
export DATABASE_URL="postgresql://gaaadmin:pass@host:5432/gaa_app"

# Deploy
./deploy-s3.sh
```

**Lambda 1 already configured to trigger Lambda 2** via:
- Environment variable: `AI_ANALYZER_FUNCTION_NAME=gaa-ai-analyzer-nov25`
- Function: `trigger_ai_analyzer(game_id, s3_key)`

---

## ğŸ’° Cost Analysis

### Per Match (10-minute analysis):

**Lambda 1 (VEO Downloader):**
- 3GB Ã— 70s = $0.01

**Lambda 2 (AI Analyzer):**
- 10GB Ã— 240s = $0.03
- Gemini Flash (calibration): $0.01
- Gemini Pro (10 clips): $0.15

**S3 Storage:**
- 2.7GB video = $0.06/month
- Negligible for analysis (same region)

**Total per match:** ~$0.20
**Monthly (100 matches):** ~$20

---

## ğŸ“± Frontend Integration

### Status Polling

Frontend polls `/api/games/:id` to check status:

```typescript
// game.status values:
'pending'     â†’ "Uploading video..."
'downloaded'  â†’ "Video ready - Starting AI analysis..."
'processing'  â†’ "Analyzing with AI..." (show progress %)
'analyzed'    â†’ "Complete!" (show events on timeline)
'failed'      â†’ "Error occurred"
```

### Event Display

When `status='analyzed'`, frontend:
1. Fetches events from `game.events` JSONB field
2. Transforms with `event-transformer.ts`
3. Displays on video timeline with colored markers
4. Shows in event list (filterable)
5. Calculates game stats (shots, fouls, possession %)

---

## ğŸ”§ Configuration

### Lambda 1 Environment Variables
```bash
DATABASE_URL="postgresql://..."
BACKEND_API_URL="https://api-gaa.clannai.com"
BUCKET_NAME="clann-gaa-videos-nov25"
LAMBDA_API_KEY="gaa-lambda-secret-key-change-in-production"
AI_ANALYZER_FUNCTION_NAME="gaa-ai-analyzer-nov25"  # For triggering Lambda 2
```

### Lambda 2 Environment Variables
```bash
GEMINI_API_KEY="your-gemini-api-key"
DATABASE_URL="postgresql://..."
AWS_BUCKET_NAME="clann-gaa-videos-nov25"
AWS_REGION="eu-west-1"
BACKEND_API_URL="https://api-gaa.clannai.com"
LAMBDA_API_KEY="gaa-lambda-secret-key-change-in-production"
```

### Backend Environment Variables
```bash
AWS_LAMBDA_FUNCTION_NAME="gaa-veo-downloader-nov25"  # For triggering Lambda 1
AWS_ACCESS_KEY_ID="..."
AWS_SECRET_ACCESS_KEY="..."
AWS_REGION="eu-west-1"
AWS_BUCKET_NAME="clann-gaa-videos-nov25"
```

---

## ğŸ§ª Testing

### Test Lambda 1 (VEO Downloader)
```bash
# Via backend API
curl -X POST https://api-gaa.clannai.com/api/games \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Match",
    "teamId": "YOUR_TEAM_ID",
    "videoUrl": "https://veo.co/teams/.../matches/..."
  }'

# Check CloudWatch logs
aws logs tail /aws/lambda/gaa-veo-downloader-nov25 --follow --region eu-west-1
```

### Test Lambda 2 (AI Analyzer) - After Deployment
```bash
# Manual trigger
aws lambda invoke \
  --function-name gaa-ai-analyzer-nov25 \
  --payload '{"game_id":"test-123","s3_key":"videos/test-123/video.mp4"}' \
  --region eu-west-1 \
  response.json

# Check CloudWatch logs
aws logs tail /aws/lambda/gaa-ai-analyzer-nov25 --follow --region eu-west-1
```

---

## ğŸ¯ Next Steps

1. **Deploy Lambda 2**
   ```bash
   cd lambda/gaa-ai-analyzer
   export GEMINI_API_KEY="..."
   export DATABASE_URL="..."
   ./deploy-s3.sh
   ```

2. **Test Full Flow**
   - Submit a VEO URL via webapp
   - Watch Lambda 1 download (~70s)
   - Watch Lambda 2 analyze (~3-4 min)
   - Check events appear in frontend

3. **Monitor & Optimize**
   - Check CloudWatch logs for errors
   - Monitor costs (Gemini API usage)
   - Adjust memory/timeout if needed
   - Add error notifications

4. **Future Enhancements**
   - Analyze full match (not just 10 mins)
   - Second half analysis
   - Player tracking
   - Zone/heat maps
   - Real-time analysis (streaming)

---

**Last Updated:** November 17, 2025  
**System Status:** Lambda 1 deployed âœ… | Lambda 2 ready for deployment ğŸ†•

