#!/usr/bin/env node
/**
 * Add Events from XML File to Game
 * 
 * Parses GAA XML file and adds events to game via database.
 * 
 * Usage:
 *   node scripts/add-events-from-xml.js <game-id> <path-to-xml-file>
 */

const fs = require('fs');
const path = require('path');
const { DOMParser } = require('xmldom');

// Load environment variables
const envPath = path.join(__dirname, '../backend/.env');
if (fs.existsSync(envPath)) {
  const envContent = fs.readFileSync(envPath, 'utf8');
  envContent.split('\n').forEach(line => {
    const [key, ...valueParts] = line.split('=');
    if (key && valueParts.length > 0) {
      const value = valueParts.join('=').trim();
      if (!process.env[key.trim()]) {
        process.env[key.trim()] = value.replace(/^["']|["']$/g, '');
      }
    }
  });
}

const { query } = require('../backend/utils/database');

function parseXMLToEvents(xmlPath) {
  try {
    console.log(`üìÇ Reading XML file: ${xmlPath}`);
    const xmlContent = fs.readFileSync(xmlPath, 'utf8');
    
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
    
    // Check for parsing errors
    const parserError = xmlDoc.getElementsByTagName('parsererror')[0];
    if (parserError) {
      throw new Error('Invalid XML format: ' + parserError.textContent);
    }
    
    const events = [];
    
    // Parse instance elements (VEO/iSportsAnalysis format)
    const instanceNodes = xmlDoc.getElementsByTagName('instance');
    
    console.log(`üìä Found ${instanceNodes.length} event instances in XML`);
    
    for (let i = 0; i < instanceNodes.length; i++) {
      const instance = instanceNodes[i];
      
      const idNode = instance.getElementsByTagName('ID')[0];
      const startNode = instance.getElementsByTagName('start')[0];
      const endNode = instance.getElementsByTagName('end')[0];
      const codeNode = instance.getElementsByTagName('code')[0];
      
      if (!idNode || !startNode || !codeNode) {
        console.warn(`‚ö†Ô∏è  Skipping incomplete event ${i + 1}`);
        continue;
      }
      
      const id = idNode.textContent;
      const startRaw = parseFloat(startNode.textContent);
      const endRaw = endNode ? parseFloat(endNode.textContent) : startRaw;
      const code = codeNode.textContent;
      
      // Convert from deciseconds to seconds
      const timeSeconds = Math.round(startRaw / 10);
      
      // Extract team info
      const labelNodes = instance.getElementsByTagName('label');
      let team = null;
      let player = null;
      let description = code;
      
      for (let j = 0; j < labelNodes.length; j++) {
        const label = labelNodes[j];
        const groupAttr = label.getAttribute('group');
        const textNode = label.getElementsByTagName('text')[0];
        
        if (textNode) {
          const text = textNode.textContent;
          if (groupAttr === 'Home' || groupAttr === 'Away') {
            team = groupAttr.toLowerCase();
          }
          if (groupAttr === 'Home' || groupAttr === 'Away') {
            player = text;
          }
          if (j === 0) {
            description = text;
          }
        }
      }
      
      // Map VEO codes to GAA event types
      const eventType = mapVeoCodeToGAAType(code);
      
      const event = {
        id: `event_${id}`,
        time: timeSeconds,
        team: team || 'unknown',
        action: eventType,
        outcome: 'Unknown',
        description: description,
        player: player,
        autoGenerated: false,
        validated: true,
        rawCode: code,
        rawStart: startRaw,
        rawEnd: endRaw
      };
      
      events.push(event);
    }
    
    console.log(`‚úÖ Parsed ${events.length} events from XML`);
    
    // Create GAA Events Schema format
    const eventsData = {
      match_info: {
        title: "GAA Match - XML Import",
        description: "Events imported from XML file",
        total_events: events.length,
        analysis_method: "XML Import",
        source_file: path.basename(xmlPath)
      },
      events: events
    };
    
    return eventsData;
  } catch (error) {
    console.error(`‚ùå Error parsing XML: ${error.message}`);
    throw error;
  }
}

function mapVeoCodeToGAAType(code) {
  const codeMap = {
    'KO': 'Kickout',
    'KICK': 'Kickout',
    'POUT': 'Point',
    'PWID': 'Point Attempt',
    'GOAL': 'Goal',
    'GWIDE': 'Goal Attempt',
    'FOUL': 'Foul',
    'FREE': 'Free Awarded',
    'MARK': 'Mark',
    'HB': 'Handpass',
    'PASS': 'Pass',
    'TACKLE': 'Tackle',
    'TURNOVER': 'Turnover',
    'CATCH': 'Catch',
    'BLOCK': 'Block',
    'SHOT': 'Shot',
    'SAVE': 'Save'
  };
  
  return codeMap[code] || code;
}

async function updateGameEvents(gameId, eventsData) {
  try {
    console.log(`üì§ Updating game ${gameId} with ${eventsData.events.length} events...`);
    
    const result = await query(
      `UPDATE games 
       SET events = $1,
           status = 'analyzed',
           updated_at = NOW()
       WHERE id = $2
       RETURNING id, title, status`,
      [JSON.stringify(eventsData), gameId]
    );
    
    if (result.rows.length === 0) {
      throw new Error('Game not found');
    }
    
    const game = result.rows[0];
    console.log(`‚úÖ Successfully updated game: ${game.title}`);
    console.log(`   Status: ${game.status}`);
    console.log(`   Events count: ${eventsData.events.length}`);
    
    return true;
  } catch (error) {
    console.error(`‚ùå Database error: ${error.message}`);
    throw error;
  }
}

async function main() {
  const args = process.argv.slice(2);
  
  if (args.length < 2) {
    console.log('Usage:');
    console.log('  node scripts/add-events-from-xml.js <game-id> <path-to-xml-file>');
    console.log('\nExample:');
    console.log('  node scripts/add-events-from-xml.js b0c476bb-401a-4a10-9a42-ae6d2e72b0e6 ~/Downloads/veo-vid-mxl.xml');
    process.exit(1);
  }
  
  const gameId = args[0];
  const xmlPath = args[1];
  
  if (!fs.existsSync(xmlPath)) {
    console.error(`‚ùå XML file not found: ${xmlPath}`);
    process.exit(1);
  }
  
  try {
    const eventsData = parseXMLToEvents(xmlPath);
    await updateGameEvents(gameId, eventsData);
    
    console.log(`\n‚úÖ Done! Game has been populated with XML events.`);
    console.log(`\nView the game at: http://localhost:4011/games/${gameId}`);
    
    process.exit(0);
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

main();

