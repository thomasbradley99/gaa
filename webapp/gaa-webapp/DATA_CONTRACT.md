# GAA Webapp Data Contract

**Version:** 1.0  
**Last Updated:** November 18, 2025  
**Purpose:** Define the exact data structures expected by the frontend for proper display

---

## üìä Complete Game Object

This is what the frontend expects when fetching `/api/games/:id`

```typescript
{
  // ===== REQUIRED FIELDS =====
  id: string                    // UUID
  title: string                 // "Kilmeena vs Cill Chomain" 
  team_id: string              // UUID - which team uploaded this
  team_name: string            // "Kerry GAA" - from JOIN with teams table
  status: string               // 'pending' | 'downloaded' | 'processing' | 'analyzed' | 'failed'
  created_at: string           // ISO timestamp
  updated_at: string           // ISO timestamp
  
  // ===== VIDEO FIELDS =====
  video_url: string            // Presigned S3 URL or VEO proxy URL
  s3_key?: string              // "videos/{game_id}/video.mp4"
  hls_url?: string             // HLS manifest URL (if transcoded)
  thumbnail_key?: string       // "videos/{game_id}/thumbnail.jpg"
  duration?: number            // Video duration in seconds
  
  // ===== EVENTS (JSONB) =====
  events: {
    match_info: {
      title: string            // "GAA Match Events"
      total_events: number     // 137
      analysis_method: string  // "Gemini AI - First 10 minutes"
      created_at: string       // ISO timestamp
      recording_start_time?: number  // Match started at X seconds in recording
    },
    
    events: Array<{
      id: string               // "event_1"
      time: number             // 23 (seconds from MATCH START, not recording start)
      team: string             // "home" | "away" | "neutral" | "red" | "blue"
      action: string           // "Shot" | "Kickout" | "Turnover" | "Throw-up" | "Foul" | etc.
      outcome: string          // "Point" | "Goal" | "Wide" | "Won" | "Lost" | "N/A"
      
      metadata?: {
        // Event-specific metadata
        scoreType?: string     // "point" | "goal" | "wide" | "saved" | "short_keeper"
        from?: string          // "play" | "free" | "45m"
        kickoutType?: string   // "long" | "short" | "mid" | "void"
        turnoverType?: string  // "forced" | "unforced"
        zone?: string          // "D1" | "M2" | "A3" etc.
        scorable?: boolean     // For fouls
        left?: boolean         // Kickout direction
        right?: boolean        
        centre?: boolean
        
        // Validation flags
        autoGenerated?: boolean // true
        validated?: boolean     // false
        userEdited?: boolean    // false
        editedAt?: string      // ISO timestamp
        
        // Display overrides (set by user in edit mode)
        player?: string        // Player name
        description?: string   // Custom description
        beforePadding?: number // 0-15 seconds
        afterPadding?: number  // 0-15 seconds
      }
    }>,
    
    team_mapping: {
      red: "home" | "away"     // Maps AI-detected colors to home/away
      blue: "home" | "away"
    },
    
    updated_at: string         // ISO timestamp
  },
  
  // ===== METADATA (JSONB) - üî¥ CRITICAL FOR DISPLAY =====
  metadata?: {
    teams?: {
      home_team: {
        name: string           // "Kilmeena" (parsed from title)
        jersey_color: string   // "green" | "blue" | "red" | "white" | "black" | hex (#016F32)
      },
      away_team: {
        name: string           // "Cill Chomain"
        jersey_color: string   // "blue" | "white" | etc.
      }
    },
    
    // Optional analytics metadata
    analysis_duration?: string     // "3m 42s"
    match_start_detected?: number  // 300 (seconds into recording)
    keeper_colors?: {
      home: string                 // "pink"
      away: string                 // "green"  
    },
    attacking_directions?: {
      home: string                 // "left-to-right"
      away: string                 // "right-to-left"
    }
  },
  
  // ===== OTHER FIELDS =====
  description?: string         // User-provided description
  file_type?: string          // "veo" | "upload" | "trace" | "spiideo"
  original_filename?: string   // "match.mp4"
  file_size?: number          // Bytes
  is_demo?: boolean           // true for demo games
  created_by?: string         // User UUID
  uploaded_by?: string        // User UUID
  xml_s3_key?: string         // "videos/{game_id}/analysis.xml"
  tactical_analysis?: object  // Future feature
  processing_progress?: {
    message: string           // "Analyzing clips..."
    percentage: number        // 45
  }
}
```

---

## üé® How Frontend Uses This Data

### 1. **VideoPlayer Component**

```typescript
// Expects:
game.video_url              // ‚úÖ Required - video source
game.hls_url                // ‚ö†Ô∏è Optional - HLS if available
game.title                  // ‚úÖ Required - display name

// Team colors (CRITICAL):
game.metadata.teams.home_team.name          // ‚ùå Currently missing
game.metadata.teams.home_team.jersey_color  // ‚ùå Currently missing
game.metadata.teams.away_team.name          // ‚ùå Currently missing
game.metadata.teams.away_team.jersey_color  // ‚ùå Currently missing

// Falls back to:
homeTeam = { name: 'Home', jersey_color: '#000000' }  // Black
awayTeam = { name: 'Away', jersey_color: '#FFFFFF' }  // White
```

**Color Mapping:**
```typescript
const colorMap = {
  'green': '#22C55E',
  'blue': '#3B82F6',
  'red': '#DC2626',
  'white': '#FFFFFF',
  'black': '#000000',
  'yellow': '#EAB308',
  'orange': '#F97316',
  'purple': '#A855F7',
  'navy': '#1E40AF',
}
// Or pass hex directly: "#016F32"
```

### 2. **Event Transformer**

```typescript
// Input: game.events (from database JSONB)
const eventsData = {
  events: [...],           // Array of AI events
  team_mapping: { ... }    // red/blue ‚Üí home/away mapping
}

// Output: GameEvent[] (for display)
transformDatabaseEventsToGameEvents(eventsData)
// Returns array of:
{
  id: "event_1",
  type: "shot",           // Mapped from action
  timestamp: 23,          // time field
  team: "home",           // Mapped using team_mapping
  description: "Home scores a point",  // Generated
  metadata: { ... }       // Preserved + enhanced
}
```

### 3. **Timeline Display**

Uses `game.metadata.teams` to color the timeline:
- Home events ‚Üí `game.metadata.teams.home_team.jersey_color`
- Away events ‚Üí `game.metadata.teams.away_team.jersey_color`

Without this data:
- ‚ùå Timeline shows all events as black/white
- ‚ùå No visual distinction between teams
- ‚ùå Looks boring/confusing

### 4. **Score Calculator**

```typescript
calculateScore(events)
// Counts events where:
// - action === 'Shot'
// - outcome === 'Point' or 'Goal'
// Returns:
{
  home: { goals: 2, points: 15, display: "2-15" },
  away: { goals: 1, points: 12, display: "1-12" }
}
```

### 5. **Game Stats**

Aggregates events by:
- Shot accuracy (shots vs points/goals)
- Kickout success rate
- Turnover stats
- Foul counts

All grouped by `team` field.

---

## üöÄ Lambda Output Requirements

### Lambda 2 Must POST to `/api/games/:id/events`

```json
{
  "events": [
    {
      "id": "event_1",
      "time": 23,
      "team": "home",
      "action": "Throw-up",
      "outcome": "N/A",
      "metadata": {
        "validated": false,
        "autoGenerated": true,
        "possessionOutcome": "won"
      }
    },
    {
      "id": "event_2",
      "time": 27,
      "team": "home",
      "action": "Shot",
      "outcome": "Point",
      "metadata": {
        "from": "play",
        "scoreType": "point",
        "validated": false,
        "autoGenerated": true
      }
    }
  ],
  
  "match_info": {
    "title": "10-minute analysis",
    "total_events": 137,
    "analysis_method": "Gemini AI - First 10 minutes",
    "recording_start_time": 300,
    "created_at": "2025-11-18T15:00:00Z"
  },
  
  "team_mapping": {
    "red": "home",
    "blue": "away"
  },
  
  "metadata": {
    "teams": {
      "home_team": {
        "name": "Kilmeena",
        "jersey_color": "green"
      },
      "away_team": {
        "name": "Cill Chomain",
        "jersey_color": "blue"
      }
    },
    "analysis_duration": "3m 42s",
    "match_start_detected": 300,
    "keeper_colors": {
      "home": "pink",
      "away": "green"
    }
  }
}
```

**Backend will store this as:**
```sql
UPDATE games
SET events = '{
  "match_info": {...},
  "events": [...],
  "team_mapping": {...},
  "updated_at": "2025-11-18T15:03:42Z"
}',
metadata = '{
  "teams": {...},
  "analysis_duration": "3m 42s",
  ...
}',
status = 'analyzed'
WHERE id = :game_id
```

---

## üî¥ Current Gaps (What's Missing)

### 1. **Lambda doesn't populate `metadata.teams`**
- ‚úÖ Stage 0.5 DETECTS team colors (`team_a_color`, `team_b_color`)
- ‚ùå But doesn't SEND them in `post_results_to_backend()`
- ‚ùå Doesn't parse team names from title

### 2. **Backend doesn't store metadata separately**
- Backend endpoint receives `metadata` in request
- But only stores it if Lambda sends it
- Currently Lambda only sends: `events`, `match_info`, `team_mapping`

### 3. **Frontend falls back to black/white**
- Line 324 in `VideoPlayer.tsx`:
```typescript
const homeTeam = game.metadata?.teams?.home_team || { name: 'Home', jersey_color: '#000000' }
const awayTeam = game.metadata?.teams?.away_team || { name: 'Away', jersey_color: '#FFFFFF' }
```

---

## ‚úÖ Required Lambda Changes

### File: `lambda/gaa-ai-analyzer/lambda_handler_s3.py`

#### Change 1: Parse team names from title

```python
def parse_team_names(title):
    """Extract team names from title like 'Team A vs Team B'"""
    # Common separators: "vs", "v", "-"
    separators = [' vs ', ' v ', ' - ']
    
    for sep in separators:
        if sep in title.lower():
            parts = title.split(sep, 1)
            if len(parts) == 2:
                return {
                    'home_team': parts[0].strip(),
                    'away_team': parts[1].strip()
                }
    
    # Fallback
    return {
        'home_team': 'Home',
        'away_team': 'Away'
    }
```

#### Change 2: Update `post_results_to_backend()`

```python
def post_results_to_backend(game_id, events_json, team_mapping, title, team_colors):
    """Post analysis results with complete metadata"""
    
    # Parse team names
    team_names = parse_team_names(title)
    
    payload = {
        'events': events_json.get('events', []),
        'match_info': {
            'title': events_json.get('title', 'GAA Match'),
            'total_events': len(events_json.get('events', [])),
            'analysis_method': 'Gemini AI - First 10 minutes',
            'created_at': events_json.get('timestamp')
        },
        'team_mapping': team_mapping,
        
        # ADD THIS SECTION:
        'metadata': {
            'teams': {
                'home_team': {
                    'name': team_names['home_team'],
                    'jersey_color': team_colors['home']  # From Stage 0.5
                },
                'away_team': {
                    'name': team_names['away_team'],
                    'jersey_color': team_colors['away']
                }
            }
        }
    }
    
    # ... rest of function
```

#### Change 3: Call with team colors

```python
# In lambda_handler, after Stage 0.5:
team_colors = {
    'home': team_a_color,  # Already detected
    'away': team_b_color
}

# Later, when posting:
post_results_to_backend(
    game_id, 
    events_json, 
    team_mapping,
    title,           # ADD
    team_colors     # ADD
)
```

### Backend Change (Optional - Handle metadata)

File: `backend/routes/games.js`

```javascript
router.post('/:id/events', authenticateLambda, async (req, res) => {
  const { events, match_info, team_mapping, metadata } = req.body;
  
  // Build events JSONB
  const eventsData = {
    match_info: match_info || {...},
    events: events,
    team_mapping: team_mapping || null,
    updated_at: new Date().toISOString()
  };
  
  // Update query to also store metadata
  const updateResult = await query(
    `UPDATE games 
     SET events = $1::jsonb,
         metadata = $2::jsonb,     -- ADD THIS
         status = 'analyzed',
         updated_at = NOW()
     WHERE id = $3
     RETURNING id, status`,
    [
      JSON.stringify(eventsData), 
      JSON.stringify(metadata || {}),  // ADD THIS
      id
    ]
  );
  
  // ...
});
```

---

## üìã Testing Checklist

After implementing changes:

1. ‚úÖ Deploy updated Lambda 2
2. ‚úÖ Submit a test VEO URL
3. ‚úÖ Check Lambda CloudWatch logs for:
   - `team_a_color` and `team_b_color` detected
   - Parsed team names from title
   - POST payload includes `metadata.teams`
4. ‚úÖ Check database:
   ```sql
   SELECT 
     id, 
     title, 
     metadata->'teams' as teams,
     events->'team_mapping' as team_mapping
   FROM games 
   WHERE id = 'test-game-id';
   ```
5. ‚úÖ Check frontend display:
   - Timeline shows correct team colors
   - Event badges show team colors
   - No black/white fallback

---

## üéØ Summary

**Frontend Needs:**
```typescript
game.metadata.teams.home_team.{name, jersey_color}
game.metadata.teams.away_team.{name, jersey_color}
```

**Lambda Currently Provides:**
```python
# ‚ùå Nothing - metadata not sent
```

**Lambda Should Provide:**
```python
{
  'metadata': {
    'teams': {
      'home_team': {'name': 'Kilmeena', 'jersey_color': 'green'},
      'away_team': {'name': 'Cill Chomain', 'jersey_color': 'blue'}
    }
  }
}
```

**Result:**
- ‚úÖ Timeline colors match actual team jerseys
- ‚úÖ Stats grouped by real team names
- ‚úÖ Professional, polished display
- ‚úÖ No confusing black/white defaults

---

**Next Step:** Update Lambda code and deploy! üöÄ

