    if prompt_tokens > 200_000:
        input_cost = (prompt_tokens / 1_000_000) * 2.50
        output_cost = (output_tokens / 1_000_000) * 15.00
    else:
        input_cost = (prompt_tokens / 1_000_000) * 1.25
        output_cost = (output_tokens / 1_000_000) * 10.00
    total_cost = input_cost + output_cost
    return input_cost, output_cost, total_cost


def _build_stage3_prompt(narrative_block: str, team_mapping: str, start_seconds: int, end_seconds: int) -> str:
    duration_minutes = max(end_seconds - start_seconds, 60) / 60
    segment_context = (
        f"SEGMENT: {_format_clock(start_seconds)} to {_format_clock(end_seconds)} (~{duration_minutes:.0f} minutes)"
    )

    return f"""Hello! You're the final step in our GAA (Gaelic Athletic Association) event detection pipeline.

{segment_context}

**WHAT YOU'RE WORKING WITH:**
You have a coherent narrative that's already been sanity-checked. Now extract the real events and convert team colors to Own/Opp labels for our database.

{team_mapping}

**YOUR TASK:**
Read the narrative and extract events. The timestamps are already in absolute game time (e.g., 11:25, 14:33), so just use them as-is.

**IMPORTANT - ONLY EXTRACT EVENTS THAT ARE EXPLICITLY MENTIONED:**
Don't invent events, but when the narrative clearly says the ball goes over the bar (point) or into the net (goal), extract it as a score even if there are multiple in the segment.

Handle structured restarts carefully:
- **Scores (Points/Goals):** Any explicit "ball goes over the bar", "ball goes into the net", "scores", or obvious celebration cue → extract as "Shot Own/Opp" with appropriate tag ([Point], [Goal], [Wide]).
- **Kickouts:** Only if it says "takes the kickout" or equivalent restart action (not just "prepares").
- **Throw-ups:** Only if it says "throw-up" or referee restarts play.
- **Half starts/ends:** Only if explicitly stated ("whistle blows to start", "half ends").

**ALL EVENTS TO EXTRACT:**

**GAA EVENTS WE'RE TRACKING:**

**Restarts:**
- "Kickout Own/Opp" - Goalkeeper restarts after a score (add tags: [Long/Mid/Short], [Left/Centre/Right], [Won/Lost])
- "Throw Up" - Referee restarts play from contested ball (add tag: [Won] if team wins possession)

**Possession & Attacks:**
- "Possession Own/Opp" - Team has possession (add tags: [Won/Lost/Turnover/Attack])
- "Pos Own Att/Pos Opp ATT" - Team in possession attacking (add tags: [Turnover/Kickout Own/KIckout Opp])
- "Attack Own/Attack OPP" - Team actively attacking toward goal
- "Turnover Won/Turnover lost" - Possession changes (add tags: [Forced/Unforced], [A1/A2/A3/M1/M2/M3/D1/D2/D3], [attack third/middle third/defensive])

**Shots:**
- "Shot Own/Opp" - ANY strike toward goal (add tags: [From Play/From Free], [Point/Goal/Wide/45m/Short Keeper/Pass / Other/Rebound Post/Save])

**Fouls:**
- "Foul Awarded/Foul Conceded" - Foul committed (team perspective)
- "Scoreable Foul Awarded/Scoreable Foul Conceded" - Foul that results in a scoreable opportunity

**Other:**
- "Ball in Play" - Active play ongoing
- "Stoppage" - Play stopped (add tags: [Point/Goal/Wide])
- "Highlight" - Notable moment (add tags: [Point/Goal])
- "Hot Ball" - Contested ball situation (add tag: [Won])
- "Referee" - Referee decision/whistle

**Match Structure:**
- "1st Half Start", "1st Half End", "2nd Half Start", "2nd Half End"

**HOW TO EXTRACT:**
Only extract events that are **explicitly mentioned** in the narrative. Don't infer or add events.

**EXTRACTION EXAMPLES:**
- Narrative: "11:41 - Blue player intercepts in midfield" → YOU: "11:41 - Turnover Won: Blue intercepts"
- Narrative: "13:20 - White player attacks down the right" → YOU: "13:20 - Attack Own: White attacks"
- Narrative: "17:15 - Blue player takes a shot, scores a point" → YOU: "17:15 - Shot Opp [From Play] [Point]: Blue scores point"
- Narrative: "15:45 - White player takes a shot, goalkeeper saves" → YOU: "15:45 - Shot Own [From Play] [Save]: White shoots, keeper saves"
- Narrative: "14:20 - Blue goalkeeper takes kickout after point" → YOU: "14:20 - Kickout Opp [Long] [Centre] [Lost]: Blue restarts"
- Narrative: "16:30 - Referee throws up ball" → YOU: "16:30 - Throw Up [Won]: Referee restart"
- Narrative: "18:45 - White player scores a goal" → YOU: "18:45 - Shot Own [From Play] [Goal]: White scores goal"
- Narrative: "20:10 - Blue player shoots wide" → YOU: "20:10 - Shot Opp [From Play] [Wide]: Blue shoots wide"
- Narrative: "18:45 - White commits foul, referee awards free" → YOU: "18:45 - Foul Conceded: White fouls"
- Narrative: "20:23 - Blue wins possession in defensive third" → YOU: "20:23 - Turnover Won [Unforced] [D3] [defensive]: Blue wins ball"

**OUTPUT FORMAT:**
MM:SS - Event Code [Tag if needed]: Brief description

**KEY RULES:**
1. **Timestamps:** Already in absolute game time (11:25, 14:33) - use them as-is
2. **Team colors → Own/Opp:** Convert using the mapping and spatial context above
3. **TURNOVER PERSPECTIVE** (CRITICAL - use spatial context!):
   - "Turnover Won" = HOME team GAINS possession from opponent
   - "Turnover lost" = HOME team LOSES possession to opponent
   - If narrative says "White forces turnover" and White=Away → "Turnover lost" for Home
4. **FOUL PERSPECTIVE** (use context!):
   - "Foul Awarded" = Free TO home (opponent fouled us)
   - "Foul Conceded" = Free BY home (we fouled opponent)
5. **Only what's mentioned:** Don't add events not in the narrative
