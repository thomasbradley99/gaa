# GAA Events Display Plan

## üéØ Goal
Display GAA match events from AI analysis pipeline in the webapp - timeline overlay + events list.

---

## üìä Current State

### What We Have:
1. **GAA Events Schema** - Standard format from AI pipeline
   - Format: `{ id, time, team: 'red'|'blue', action, outcome, autoGenerated, validated }`
   - Actions: `Throw-up`, `Turnover`, `Kickout`, `Shot`, `Foul`, `Yellow Card`, `Black Card`, `Red Card`
   - Outcomes: `Won`, `Lost`, `1Point`, `Goal`, `Wide`, `Saved`, `N/A`

2. **Anadi XML Format** - What Anadi expects
   - XML structure with `<instance>` tags
   - Fields: `ID`, `start`, `end`, `code`, `label` (optional)

3. **Database** - `events JSONB` field in `games` table
   - Currently empty, ready to store events

4. **Frontend Components** - Already built:
   - `EventList.tsx` - Shows events in sidebar
   - `VideoOverlayTimeline.tsx` - Shows events on video timeline
   - `GameEvent` type - Simplified format

5. **Event Data Files** - From AI pipeline:
   - `gaa/ai/ss/gaapipeline/commentator-method/results/structured_events/match_events.json`
   - `gaa/ai/ss/gaapipeline/simple-event-detection/results/direct_events.json`

---

## üîÑ Data Flow

### Step 1: AI Pipeline ‚Üí Database
**Input:** AI pipeline generates events in GAA Events Schema format
**Storage:** Store in `games.events` JSONB field

**Format:**
```json
{
  "match_info": {
    "title": "GAA Match - Events",
    "total_events": 32,
    "analysis_method": "AI narrative analysis"
  },
  "events": [
    {
      "id": "event_1",
      "time": 19,
      "team": "blue",
      "action": "Kickout",
      "outcome": "Lost",
      "autoGenerated": true,
      "validated": false
    },
    {
      "id": "event_2",
      "time": 54,
      "team": "red",
      "action": "Shot",
      "outcome": "1Point",
      "autoGenerated": true,
      "validated": false
    }
  ]
}
```

### Step 2: Database ‚Üí Backend API
**Backend:** Return `events` JSONB field as-is
**Endpoint:** `GET /api/games/:id` already returns `game.events`

### Step 3: Backend ‚Üí Frontend
**Frontend:** Transform GAA Events Schema ‚Üí `GameEvent` format

**Transformation needed:**
- `team: 'red'|'blue'` ‚Üí `team: 'home'|'away'` (need team mapping)
- `action` ‚Üí `type` (map to simplified types)
- `time` ‚Üí `timestamp`
- `outcome` ‚Üí `metadata` or `description`

### Step 4: Frontend Display
**Components:**
- `VideoOverlayTimeline` - Shows events as markers on timeline
- `EventList` - Shows events in sidebar with filters

---

## üó∫Ô∏è Team Mapping Challenge

**Problem:** AI pipeline uses `'red'` and `'blue'`, but webapp uses `'home'` and `'away'`

**Solution Options:**

### Option 1: Store Team Mapping in Database
```sql
-- Add to games table
ALTER TABLE games ADD COLUMN team_mapping JSONB;
-- Example: { "red": "home", "blue": "away" }
```

### Option 2: Use First Team as Home
- First team mentioned in events = home
- Second team = away
- Store mapping in `metadata` JSONB

### Option 3: User Selects Teams
- When game is created, user selects which team is home/away
- Store in `metadata` or new `home_team`/`away_team` fields

**Recommendation:** Option 1 - Store team mapping when game is created or when events are added.

---

## üîß Implementation Plan

### Phase 1: Event Data Transformation (Backend)

**File:** `backend/utils/events.js`

**Functions:**
1. `transformGAEEventsToGameEvents(gaaEvents, teamMapping)` - Convert GAA schema ‚Üí GameEvent
2. `mapTeamColorToHomeAway(team, teamMapping)` - Map red/blue ‚Üí home/away
3. `mapActionToEventType(action, outcome)` - Map action ‚Üí simplified type

**Action ‚Üí Type Mapping:**
```javascript
{
  'Shot' + '1Point' ‚Üí 'point'
  'Shot' + 'Goal' ‚Üí 'score'
  'Shot' + 'Wide' ‚Üí 'point' (missed)
  'Foul' ‚Üí 'foul'
  'Yellow Card' | 'Black Card' | 'Red Card' ‚Üí 'card'
  'Turnover' ‚Üí 'substitution' (or new type?)
}
```

### Phase 2: Backend API Updates

**File:** `backend/routes/games.js`

**Update `GET /api/games/:id`:**
- Parse `events` JSONB from database
- Transform using `transformGAEEventsToGameEvents()`
- Return transformed events in response

**New Endpoint:** `POST /api/games/:id/events`
- Accept events from AI pipeline
- Store in `events` JSONB field
- Update `status` to 'analyzed'

### Phase 3: Frontend Updates

**File:** `frontend/src/app/games/[id]/page.tsx`

**Current:** Already parsing events, but needs transformation

**Update:**
- Check if events are in GAA schema format
- Transform if needed (or do in backend)
- Pass to `EventList` and `VideoOverlayTimeline`

**File:** `frontend/src/components/games/video-player/types.ts`

**Update `GameEvent` type:**
```typescript
export interface GameEvent {
  id: string
  type: 'score' | 'point' | 'foul' | 'card' | 'turnover' | 'kickout' | 'throw-up'
  timestamp: number
  team: 'home' | 'away'
  player?: string
  description?: string
  metadata?: {
    action?: string  // Original action from AI
    outcome?: string  // Original outcome
    cardType?: 'yellow' | 'black' | 'red'
    scoreType?: 'goal' | 'point'
    autoGenerated?: boolean
    validated?: boolean
  }
}
```

### Phase 4: Event Display Enhancements

**Timeline (`VideoOverlayTimeline.tsx`):**
- Color-code by team (green for home, yellow for away)
- Different icons for different event types
- Click to seek to timestamp
- Show event details on hover

**Event List (`EventList.tsx`):**
- Filter by team (home/away/all)
- Filter by event type
- Sort by timestamp
- Highlight current event (near currentTime)
- Show event details (action, outcome, description)

---

## üìã Action ‚Üí Display Type Mapping

| AI Action | Outcome | Display Type | Icon/Color |
|-----------|---------|--------------|------------|
| Shot | 1Point | `point` | Green dot |
| Shot | Goal | `score` | Green star |
| Shot | Wide | `point` (missed) | Gray dot |
| Shot | Saved | `point` (saved) | Yellow dot |
| Foul | N/A | `foul` | Yellow marker |
| Yellow Card | N/A | `card` | Yellow card icon |
| Black Card | N/A | `card` | Black card icon |
| Red Card | N/A | `card` | Red card icon |
| Turnover | Won/Lost | `turnover` | Blue marker |
| Kickout | Won/Lost | `kickout` | Orange marker |
| Throw-up | Won/Lost | `throw-up` | White marker |

---

## üé® UI Improvements

### Event Timeline
- **Markers:** Different shapes for different event types
  - Circle = Point/Shot
  - Star = Goal
  - Triangle = Foul
  - Square = Card
  - Diamond = Turnover/Kickout
- **Colors:** Team-based (green/yellow)
- **Size:** Larger for important events (goals, cards)

### Event List
- **Grouping:** Group by half (if half markers exist)
- **Search:** Search by player name or description
- **Sort:** By time (default), by type, by team
- **Badges:** Show validated vs auto-generated

---

## üîÑ Integration with AI Pipeline

### When Events Are Added:

**Option A: Manual Upload**
- User uploads events JSON file
- Backend validates and stores

**Option B: Lambda Processing** (Future)
- Lambda runs AI analysis
- Lambda stores events in database
- Frontend polls/refreshes

**Option C: API Endpoint** (Recommended for now)
- AI pipeline calls `POST /api/games/:id/events`
- Backend stores events
- Frontend automatically shows events

---

## üìù Database Schema

**Current:**
```sql
events JSONB  -- Stores events array
```

**Recommended Structure:**
```json
{
  "match_info": {
    "title": "...",
    "total_events": 32,
    "analysis_method": "AI narrative analysis",
    "team_mapping": {
      "red": "home",
      "blue": "away"
    }
  },
  "events": [
    {
      "id": "event_1",
      "time": 19,
      "team": "blue",
      "action": "Kickout",
      "outcome": "Lost",
      "autoGenerated": true,
      "validated": false
    }
  ]
}
```

---

## ‚úÖ Implementation Checklist

### Backend
- [ ] Create `backend/utils/events.js` - Event transformation utilities
- [ ] Update `GET /api/games/:id` - Transform events before returning
- [ ] Create `POST /api/games/:id/events` - Accept events from AI pipeline
- [ ] Add team mapping logic (red/blue ‚Üí home/away)

### Frontend
- [ ] Update `GameEvent` type - Support GAA schema fields
- [ ] Update `EventList.tsx` - Handle new event types
- [ ] Update `VideoOverlayTimeline.tsx` - Show all event types
- [ ] Add event type icons/colors
- [ ] Add event filtering/search

### Testing
- [ ] Test with sample event data from AI pipeline
- [ ] Test team mapping (red/blue ‚Üí home/away)
- [ ] Test event display on timeline
- [ ] Test event list filtering
- [ ] Test click-to-seek functionality

---

## üöÄ Quick Start

**To test with existing data:**

1. **Load sample events:**
   ```bash
   # Use events from AI pipeline
   cat gaa/ai/ss/gaapipeline/commentator-method/results/structured_events/match_events.json
   ```

2. **Add to database:**
   ```sql
   UPDATE games 
   SET events = '{"match_info": {...}, "events": [...]}'::jsonb
   WHERE id = 'your-game-id';
   ```

3. **Test display:**
   - Open game detail page
   - Events should appear on timeline and in sidebar

---

**Last Updated:** 2025-01-13  
**Status:** Planning Phase

